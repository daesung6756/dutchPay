# AI 사용 가이드라인 (Dutch-Pay 마이크로사이트)

## 목적
- 이 문서는 마이크로사이트에서 AI(예: 텍스트 생성, 요약, 추천)를 안전하고 일관되게 활용하기 위한 가이드라인을 제공합니다.
- 개발자, 디자이너, PM, 검수자 모두가 따를 수 있는 규칙과 템플릿을 포함합니다.

## 범위
- 프론트엔드에서 UI 텍스트 생성, 트랜잭션 요약, 사용성 도움말, 에러 메시지 개선 등에 AI를 사용할 때 적용합니다.
- 서버사이드/클라이언트 사이드 호출, 사용자 데이터 취급, URL 내 데이터 인코딩 관련 지침을 포함합니다.

## 원칙
1. 개인정보 최소 수집: URL에 저장하는 데이터는 민감정보를 포함하지 않아야 합니다.
2. 투명성: 사용자에게 AI가 개입했음을 명시해야 합니다(예: "AI가 생성한 요약").
3. 안전성: 혐오·차별·불법 행위 조장 등 부적절한 콘텐츠는 차단합니다.
4. 재현 가능성: 프롬프트 템플릿과 모델 버전을 명시하여 결과가 예측 가능하도록 합니다.
5. 언어 일관성: 모든 AI가 생성한 응답(요약·메시지·알림 등)은 사용자에게 제공하기 전에 반드시 한국어로 번역하여 표시해야 합니다. (프로젝트 내 최우선 규칙)

## 개발자 체크리스트 (작업 시 반드시 확인할 항목)
- **내부 규칙 용도 확인**: 이 문서는 내부 운영 규칙이며 법률/보안팀 리뷰 불필요.
- **PII 필터링**: 사용자 입력(메모 등)에 대해 정규식 기반 PII 검사 실행. 차단 시 사용자에게 경고 메시지 표시.
- **URL 저장 제한**: URL에 저장할 수 있는 필드만 사용(별칭, 금액, 100자 이하 메모). 민감정보 절대 불가.
- **길이 및 인코딩**: JSON → gzip(또는 deflate) → base64url 권장. URL 길이가 2000자 이상일 경우 압축/요약 적용.
- **프롬프트 템플릿 고정**: 서버/클라이언트에서 사용하는 프롬프트 템플릿을 코드로 관리하고 버전 기록.
- **모델/메타로그 기록**: 요청 시 모델명, 버전, 프롬프트 템플릿 ID, 타임스탬프만 로그(사용자 텍스트는 최소화).
- **비용·호출 빈도 제한**: 유효성검사 및 간단 로컬 요약으로 불필요한 API 호출 최소화.
- **유해성 필터링**: 생성 결과에 대해 간단한 유해성 체크(성·폭력·차별) 적용 후 노출.

## 짧은 실행 가이드
- 작업 흐름 예시: 입력 수집 → PII 필터 → 로컬 요약(필요시) → 프롬프트 생성 → 모델 호출 → 유해성 필터 → 출력 노출.
- URL 인코딩 예시: `{"items":[{"name":"A","amount":12000}],"note":"같이먹은거"}` → gzip → base64url → URL 파라미터.
- PII 정규식 예시(간단): 주민등록번호 감지: `\\b\\d{6}-?\\d{7}\\b` / 카드번호(간단): `\\b\\d{4}[ -]?\\d{4}[ -]?\\d{4}[ -]?\\d{4}\\b`.


## UI/컴포넌트 및 로딩 지침
- 로딩 UI 정책: 모든 화면에서 로딩 처리는 "스켈레톤(skeleton)"과 "일반 로딩(스피너 등)" 방식을 공통 디자인 패턴으로 제공한다. 상황에 따라 둘 중 하나를 사용하되, 공통 스타일 가이드를 따르세요.
- 스켈레톤 제작: 스켈레톤은 실제 레이아웃 구조를 그대로 반영하여 제작한다(레이아웃 형태 그대로). 사용자에게 레이아웃 변화가 없도록 시각적 자리표시자 역할만 수행해야 함.
- 컴포넌트화 기준: 재사용성이 요구되는 UI 단위(버튼 그룹, 항목 카드, 리스트, 스켈레톤 블록 등)는 반드시 재사용 가능한 컴포넌트로 구현한다. 재사용 컴포넌트는 props로 데이터와 상태(loading, error 등)를 명확히 받도록 설계할 것.
- 레이아웃 강제 사용: 기본 페이지를 생성할 때는 프로젝트의 레이아웃 컴포넌트(예: `AppLayout`, `PageLayout`)를 반드시 사용한다. 레이아웃 컴포넌트는 스켈레톤·헤더·푸터·공통 스타일을 포함해야 함.
- 접근성 및 성능: 스켈레톤/로딩 컴포넌트는 접근성(a11y)을 고려(읽기 전용 텍스트 대체, 화면 리더 처리)하고, 불필요한 렌더링을 피하도록 최적화할 것.
- 구현 팁: Tailwind + shadcn-ui 컴포넌트를 기반으로 스켈레톤 스타일을 통일하고, `loading` 상태를 공유하는 상위 스토어(Zustand) 또는 컨텍스트를 활용해 동기화된 로딩 UI를 유지하세요.

## 금지 항목
- 주민등록번호, 계좌 비밀번호, 신용카드 전체 번호 등 민감한 PII를 URL이나 로그에 저장/전송 금지.
- 인종차별·성차별·폭력 조장·불법행위 조장 내용 생성 요청 금지.

## 데이터 처리 원칙
- URL에 저장하는 정보: 참가자 닉네임(별칭 허용), 지불 금액(숫자), 선택적 메모(짧은 텍스트, 민감정보 금지)
- 길이 제한: URL 길이가 브라우저 및 플랫폼 제한(약 2000~8000자)을 초과하지 않도록 설계. 긴 데이터는 요약 또는 압축(base64url→압축) 적용.
- 암호화: 공개 공유 링크는 누구나 볼 수 있으므로 개인식별 정보는 포함하지 않음. 민감정보 필요 시 서버 저장+권한부여 방식 권장.

## 프롬프트 템플릿 (예시)
- 트랜잭션 요약 생성
  - 시스템: "너는 친절한 결제 요약 생성자야. 입력된 항목을 간결하고 이해하기 쉽게 정리해줘. 민감한 정보를 포함하지 마." 
  - 사용자: "다음 항목을 요약해줘: {items} (각 항목: 이름, 금액, 메모). 출력 형식: `- 이름: 금액 (메모)` 한 줄에 한 항목. 마지막에 총합 표시." 

- 메시지 작성(초대 메시지)
  - 시스템: "초대 메시지 생성을 도와줘. 톤: 친근·간결." 
  - 사용자: "{host}가 다음 금액을 분담합니다: {split_summary}. 수락/거절 링크 포함 안 함." 

## 모델 버전 및 비용 고려
- 모델 버전 명시: 사용 시 `gpt-5-mini`(예시) 또는 실제 사용하는 모델명을 로그/문서에 기록.
- 토큰 사용량·비용을 모니터링하고, 불필요한 호출을 피하기 위해 클라이언트에서 로컬 요약/검증을 먼저 수행.

## 민감데이터 처리 예시
- 잘못된 예: 참여자 메모에 주민등록번호가 포함되어 URL에 저장됨 → 금지
- 권장 예: 참여자 이름은 첫 이름 또는 별칭만 사용, 메모는 100자 제한, 정규식으로 PII 필터링 적용

## 검증 및 휴리스틱
- 입력 필터링: 메모에 숫자 긴 문자열(신용카드, 주민번호 형식) 감지 시 저장 차단 및 사용자에게 경고.
- 생성된 요약 검토: 자동 검출(성인/폭력 등) 모델을 거쳐 노출 전 필터링.

## 로깅 및 모니터링
- AI 요청·응답의 메타데이터(프롬프트 템플릿, 모델 버전, 타임스탬프)만 로그. 사용자 텍스트 전체 로그는 최소화.
- 오류·잘못된 출력 사례는 내부 피드백 루프에 기록해 프롬프트 개선에 사용.

## 책임과 연락처
- 가이드라인 위반이나 안전 문제 발견 시 즉시 `#security` 채널로 보고.
- 문서 책임자: 제품팀 / 연락: product@example.com

## 버전 기록
- v0.1 (초안)

---
참고: 이 문서는 초기 가이드라인이며, 실제 구현 단계에서 법률·보안 팀의 리뷰를 권장합니다.

## 권장 파일/폴더 구조
아래 구조는 이 프로젝트에서 AI 관련 코드·프롬프트·테스트를 조직하는 권장 형태입니다. 내부 규칙이므로 필요에 따라 조정하세요.

- `docs/`
  - `docs/AI_GUIDELINES.md`  : 이 가이드라인 원본(프로젝트 루트의 참조 복사)
  - `docs/PRD.md`, `docs/TECH_SPEC.md` 등
- `src/`
  - `src/app/` (Next.js App Router 페이지/레이아웃)
  - `src/components/` : UI 컴포넌트
  - `src/lib/ai/` : AI 호출 래퍼, 프롬프트 템플릿 로더, 메타로그 유틸
    - `src/lib/ai/prompt-templates.ts` : 프롬프트 템플릿 및 버전 식별자
    - `src/lib/ai/client.ts` : 모델 호출 래퍼(로깅·에러처리·시간초과 등)
  - `src/lib/encoding/` : 인코딩·디코딩(압축, base64url) 유틸
  - `src/lib/pii/` : PII 필터 정규식·유틸
  - `src/pages/api/` : optional serverless API(단축 링크, 서버사이드 AI 호출 등)
  - `src/middleware/` : 요청·입력 처리 미들웨어(클라이언트/서버에서 재사용 가능한 유틸)
    - `src/middleware/piiMiddleware.ts` : PII 감지/차단 유틸(클라이언트 + 서버에서 사용)
    - `src/middleware/aiMiddleware.ts` : AI 호출 전후 공통 처리(타임아웃, 로깅 제한 등)
  - `src/types/` : TypeScript 공통 타입 정의
    - `src/types/models.ts` : `Split`, `Item` 등 도메인 타입
  - `src/lib/store/` : Zustand 등 상태관리 스토어
    - `src/lib/store/useSplitStore.ts` : 더치페이 상태 관리(예시)
- `public/` : 정적 자산
- `tests/`
  - `tests/unit/ai/` : 인코딩·디코딩·PII 필터 유닛 테스트
  - `tests/e2e/` : 생성→공유→열람 플로우 E2E 테스트
- `scripts/`
  - `scripts/generate-prompts.js` : 템플릿 관리용 도구(선택)

설계 지침(간단)
- 프롬프트 템플릿은 코드(예: `src/lib/ai/prompt-templates.ts`)로 버전 관리하고, 변경 시 `promptTemplateId`를 증가시키세요.
- 민감 데이터 체크는 UI 레이어와 `src/lib/pii/` 유틸에서 이중으로 수행하세요.
- AI 호출 래퍼(`src/lib/ai/client.ts`)는 호출 메타데이터만 로그하고 원문 텍스트는 기록하지 않도록 구현하세요.
